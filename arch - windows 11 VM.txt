Under BIOS {
    On Intel CPU {
        Enable Intel VT-x
        Enable Intel VT-d
    }
    On AMD CPU {
        Enable AMD-V
        Enable AMD-Vi
    }
	? Set primary GPU = iGPU
}

cat /sys/devices/system/cpu/cpu*/topology/thread_siblings_list | sort | uniq # get CPU topology
## example output
0,6
1,7
2,8
3,9
4,10
5,11
##

? Add kernel args "amd_iommu=on isolcpus=1,2,3,4,5,7,8,9,10,11"

lspci -nn # find <gpu ids>

sudo nano /etc/modprobe.d/vfio.conf {
    Add "options vfio-pci ids=<gpu ids>" # eg. <gpu ids>=10de:1c03,10de:10f1
}
sudo nano /etc/modules-load.d/vfio-pci.conf {
    Add "vfio-pci"
}

dmesg | grep -E "DMAR|IOMMU # check that iommu is enabled
## example output
[    0.000000] DMAR: IOMMU enabled
##
dmesg | grep -i vfio # check that vfio-pci successfully added the GPU
## example output
[    1.025031] vfio_pci: add [10de:1c03[ffffffff:ffffffff]]
[    1.037038] vfio_pci: add [10de:10f1[ffffffff:ffffffff]]
##

? # install virt-manager
sudo pacman -S iptables-nft dnsmasq libvirt qemu virt-manager swtpm # ovmf
sudo systemctl enable libvirtd.service
sudo systemctl enable virtlogd.socket
sudo usermod -aG libvirt <username>
Restart
groups # should now include libvirt
sudo virsh net-autostart default
sudo virsh net-start default

Download Windows 11 ISO
Download virtio-win.iso from https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/stable-virtio/virtio-win.iso

virt-manager {
    Create new VM
    Select Windows 11 ISO
    Leave memory, CPU as default
    Set disk size
    Check "Customize configuration before install"
    Under Overview {
        Set chiset Q35
        Set firmware UEFI
    }
    Under Memory {
        Set current allocation so whatever
        Under XML {
            Replace "<domain type='kvm'>" with "<domain type='kvm' xmlns:qemu='http://libvirt.org/schemas/domain/qemu/1.0'>"
            Replace "<vcpu>2</vcpu>" with {
                <vcpu placement="static">4</vcpu>
                <cputune>
                    <vcpupin vcpu="0" cpuset="1"/>
                    <vcpupin vcpu="1" cpuset="7"/>
                    <vcpupin vcpu="2" cpuset="2"/>
                    <vcpupin vcpu="3" cpuset="8"/>
                </cputune>
            }
            Under "<hyperv>" add "<vendor_id state='on' value='1234567890ab'/>"
            Under "<features>" add {
                <kvm>
                    <hidden state='on'/>
                </kvm>
                <ioapic driver='kvm'/>
            }
            Replace "<cpu mode='host-model'/>" with {
                <cpu mode="host-passthrough" check="none">
                    <topology sockets="1" dies="1" cores="2" threads="2"/>
                </cpu>
            }
            Under "<domain>" add {
                <qemu:commandline>
                    <qemu:arg value='-cpu'/>
                    <qemu:arg value='host,kvm=off,hv_vendor_id=null'/>
                    <qemu:arg value='-machine'/>
                    <qemu:arg value='q35,kernel_irqchip=on'/>
                </qemu:commandline>
            }
            Click apply
        }
        Add virtio-win.iso CD?
        Remove tablet
        Under display spice {
            Add <gpu parts>
        }
        ? Add TPM module
    }
    Click begin installation
    Press any key to boot from CD
    Install Windows 11
    # GPU driver probably installs automatically, if not download the driver manually
    Install virtio-win-??-x64.msi from virtio CD, don't install guest tools otherwise the VM will stop capturing the mouse
}
